@model IEnumerable<PureFitness.Models.Member>
@{
    ViewBag.Title = "Membership Management";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@section Styles {
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" />
    <style>
        body {
            background-color: #F0F2F5;
        }

        .content-container {
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 20px;
            margin-top: 20px;
        }

        .table th, .table td {
            vertical-align: middle;
            border: 1px solid #ccc;
            padding: 10px;
        }

        .table th {
            background-color: #f5f5f5;
            font-weight: 600;
            border-bottom: 2px solid #bbb;
        }

        .table tr:hover {
            background-color: #f9f9f9;
        }

        .pagination {
            justify-content: center;
            margin-top: 15px;
        }
    </style>
}

<div class="container-fluid">
    <div class="content-container">

        @if (TempData["SuccessMessage"] != null)
        {
            <div class="alert alert-success alert-dismissible fade show" role="alert">
                @TempData["SuccessMessage"]
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        }

        <div class="d-flex flex-wrap justify-content-between align-items-end mb-3">
            <div class="d-flex align-items-end">
                <div class="me-3">
                    <input type="text" class="form-control" id="searchBox" placeholder="🔍 Search name" style="min-width:240px;" />
                </div>
                <div>
                    <label for="statusFilter" class="form-label fw-semibold">Status</label>
                    <select class="form-select" id="statusFilter" style="min-width:140px;">
                        <option value="all">All</option>
                        <option value="active">Active</option>
                        <option value="inactive">Inactive</option>
                        <option value="canceled">Canceled</option>
                    </select>
                </div>
            </div>
            <div>
                <a asp-controller="Membership" asp-action="Add" class="btn btn-dark">
                    <i class="bi bi-plus-circle"></i> Add Member
                </a>
            </div>
        </div>

        <div class="table-responsive">
            <table class="table table-hover" id="memberTable">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Gender</th>
                        <th>Membership Type</th>
                        <th>Membership Period</th>
                        <th>Access Type</th>
                        <th>Date Joined</th>
                        <th>Expiration Date</th>
                        <th>Cancellation Date</th> <!-- ✅ NEW COLUMN -->
                        <th>Status</th>
                        <th>Paid Status</th>
                        <th class="text-center">Action</th>
                    </tr>
                </thead>
                <tbody>
                    @if (Model != null && Model.Any())
                    {
                        foreach (var member in Model)
                        {
                            var today = DateOnly.FromDateTime(DateTime.Now);
                            int? daysLeft = member?.DueDate != null
                            ? member.DueDate.Value.DayNumber - today.DayNumber
                            : null;

                            <tr data-memberid="@member?.MemberId"
                                data-accesstype="@member?.AccessType"
                                data-membershiptype="@member?.MembershipType"
                                data-membershipperiod="@member?.MembershipPeriod"
                                data-name="@($"{(member?.Fname ?? "")} {(member?.Lname ?? "")}".ToLower())"
                                data-status="@((member?.Status ?? "unknown").ToLower())">

                                <td>
                                    <div class="d-flex align-items-center">
                                        <i class="bi bi-person-circle" style="font-size:2.2rem; margin-right:12px; color:#495057;"></i>
                                        <div>
                                            <div class="fw-bold">@($"{member?.Fname} {member?.Lname}")</div>
                                            <div class="text-muted" style="font-size:0.9rem;">
                                                @(member?.User!.Email ?? "No email")
                                            </div>
                                        </div>
                                    </div>
                                </td>

                                <td>@(member?.Gender ?? "N/A")</td>
                                <td>@(member?.MembershipType ?? "N/A")</td>
                                <td>@(member?.MembershipPeriod ?? "N/A")</td>
                                <td>@(member?.AccessType ?? "N/A")</td>
                                <td>@(member?.DateJoined?.ToString("MM/dd/yyyy") ?? "N/A")</td>
                                <td>@(member?.DueDate?.ToString("MM/dd/yyyy") ?? "N/A")</td>
                                <td>@(member?.CancellationDate?.ToString("MM/dd/yyyy") ?? "—")</td>

                                <td>
                                    @if (member?.Status == "Active")
                                    {
                                        <span class="badge bg-success bg-opacity-25 text-success-emphasis">Active</span>
                                    }
                                    else if (member?.Status == "Canceled")
                                    {
                                        <span class="badge bg-warning bg-opacity-25 text-warning-emphasis">Canceled</span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-danger bg-opacity-25 text-danger-emphasis">Inactive</span>
                                    }
                                </td>
                                <td>@(member?.PaidStatus ?? "N/A")</td>
                                <td class="text-center">
                                    <div class="d-flex justify-content-center gap-1 flex-wrap">
                                        <!-- Delete -->
                                        <form asp-controller="Membership" asp-action="Delete" method="post" class="d-inline">
                                            <input type="hidden" name="id" value="@(member?.MemberId ?? 0)" />
                                            <button type="submit" class="btn btn-sm btn-light" title="Delete"
                                                    onclick="return confirm('Are you sure you want to delete this member?');">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                            @Html.AntiForgeryToken()
                                        </form>

                                        <!-- Edit -->
                                        <a asp-controller="Membership" asp-action="Edit"
                                           asp-route-id="@(member?.MemberId ?? 0)"
                                           class="btn btn-sm btn-light" title="Edit">
                                            <i class="bi bi-pencil"></i>
                                        </a>

                                        <!-- Cancel -->
                                        @if (member?.Status == "Active")
                                        {
                                            <button type="button" class="btn btn-sm btn-warning text-white"
                                                    data-bs-toggle="modal" data-bs-target="#cancelModal"
                                                    data-member-id="@(member?.MemberId ?? 0)">
                                                <i class="bi bi-x-circle"></i> Cancel
                                            </button>
                                        }

                                        <!-- Renew -->
                                        @if ((member?.Status == "Active" && daysLeft.HasValue && daysLeft.Value <= 5 && daysLeft.Value >= 0)
                                       || member?.Status == "Inactive" && member?.PaidStatus == "Paid")
                                        {
                                            <button type="button" class="btn btn-sm btn-dark rounded-pill px-3 renew-btn">Renew</button>
                                        }
                                    </div>
                                </td>
                            </tr>
                        }
                    }
                    else
                    {
                        <tr>
                            <td colspan="11" class="text-center py-5">No Members found.</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        <nav><ul class="pagination" id="pager"></ul></nav>
    </div>
</div>

<!-- Cancel Confirmation Modal -->
<div class="modal fade" id="cancelModal" tabindex="-1" aria-labelledby="cancelModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content border-0 shadow">
            <div class="modal-header bg-warning text-white">
                <h5 class="modal-title" id="cancelModalLabel">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>Confirm Cancellation
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Are you sure you want to cancel this membership?
            </div>
            <div class="modal-footer">
                <form id="cancelForm" asp-action="Cancel" asp-controller="Membership" method="post">
                    <input type="hidden" name="id" id="cancelMemberId" />
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">No</button>
                    <button type="submit" class="btn btn-warning text-white">Yes, Cancel</button>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js" defer></script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const cancelModal = document.getElementById('cancelModal');
            cancelModal.addEventListener('show.bs.modal', function (event) {
                const button = event.relatedTarget;
                const memberId = button.getAttribute('data-member-id');
                document.getElementById('cancelMemberId').value = memberId;
            });
        });

        $(function () {
            const rowsPerPage = 8;
            const $table = $("#memberTable");
            const $pager = $("#pager");

            function getFilteredRows() {
                const search = $("#searchBox").val().toLowerCase();
                const status = $("#statusFilter").val();
                return $table.find("tbody tr").filter(function () {
                    const name = ($(this).data("name") || "").toLowerCase();
                    const rowStatus = ($(this).data("status") || "").toLowerCase();
                    return name.indexOf(search) > -1 && (status === "all" || rowStatus === status);
                });
            }

            function buildPager(totalPages) {
                $pager.empty();
                if (totalPages <= 1) return;
                for (let i = 1; i <= totalPages; i++) {
                    $("<li class='page-item' data-page='" + i + "'><a class='page-link' href='#'>" + i + "</a></li>").appendTo($pager);
                }
            }

            function showPage(page) {
                const $rows = getFilteredRows();
                $table.find("tbody tr").hide();
                $rows.slice((page - 1) * rowsPerPage, page * rowsPerPage).show();
                $pager.find("li").removeClass("active");
                $pager.find("li[data-page='" + page + "']").addClass("active");
            }

            function refreshPagination() {
                const $rows = getFilteredRows();
                const totalPages = Math.max(1, Math.ceil($rows.length / rowsPerPage));
                buildPager(totalPages);
                showPage(1);
            }

            refreshPagination();
            $pager.on("click", "li", function (e) {
                e.preventDefault();
                showPage($(this).data("page"));
            });
            $("#searchBox").on("input", refreshPagination);
            $("#statusFilter").on("change", refreshPagination);

            $('#memberTable').on("click", ".renew-btn", function () {
                const row = $(this).closest("tr");
                const memberId = row.data("memberid");
                if (!memberId) return;
                window.location.href = `/Payment/NewPayment?memberId=${memberId}`;
            });
        });
    </script>
    <!-- Script to link modal to button -->
    <script>
        const cancelModal = document.getElementById('cancelModal');
        cancelModal.addEventListener('show.bs.modal', event => {
            const button = event.relatedTarget;
            const memberId = button.getAttribute('data-member-id');
            document.getElementById('cancelMemberId').value = memberId;
        });
    </script>
}
