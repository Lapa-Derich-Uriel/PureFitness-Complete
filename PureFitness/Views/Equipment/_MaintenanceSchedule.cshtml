@model IEnumerable<PureFitness.Models.EquipmentSchedule>

@using System.Globalization

@{
    var list = Model?.ToList() ?? new List<PureFitness.Models.EquipmentSchedule>();
    bool allEquipmentLevel = list.Any() && list.All(s => s.EquipmentItemId == null);
    bool allItemLevel = list.Any() && list.All(s => s.EquipmentItemId != null);
}

<div class="table-responsive">
    <table class="table table-striped table-hover align-middle">
        <thead class="table-light">
            @if (allEquipmentLevel)
            {
                <!-- General Equipment header -->
                <tr>
                    <th scope="col">Category</th>
                    <th scope="col">Equipment</th>
                    <th scope="col">Start Maintenance Date</th>
                    <th scope="col">Next Maintenance Date</th>
                    <th scope="col">Frequency</th>
                    <th scope="col">Staff Handled By</th>
                    <th scope="col">Remarks</th>
                    <th scope="col">Actions</th>
                </tr>
            }
            else if (allItemLevel)
            {
                <!-- Specific Item header -->
                <tr>
                    <th scope="col">Category</th>
                    <th scope="col">Item</th>
                    <th scope="col">Status</th>
                    <th scope="col">Maintenance Date</th>
                    <th scope="col">Staff Handled By</th>
                    <th scope="col">Remarks</th>
                </tr>
            }
            else
            {
                <!-- Mixed fallback header -->
                <tr>
                    <th scope="col">Category</th>
                    <th scope="col">Equipment</th>
                    <th scope="col">Item</th>
                    <th scope="col">Status</th>
                    <th scope="col">Start / Maintenance Date</th>
                    <th scope="col">Next Maintenance Date</th>
                    <th scope="col">Frequency</th>
                    <th scope="col">Staff</th>
                    <th scope="col">Remarks</th>
                </tr>
            }
        </thead>

        <tbody>
            @if (list.Any())
            {
                foreach (var sched in list)
                {
                    bool isItem = sched.EquipmentItemId != null;

                    // Common values
                    string category = isItem
                    ? sched.EquipmentItem?.Equipment?.EquipmentCategory ?? "—"
                    : sched.Equipment?.EquipmentCategory ?? "—";

                    string equipmentName = isItem
                    ? sched.EquipmentItem?.Equipment?.EquipmentName ?? "—"
                    : sched.Equipment?.EquipmentName ?? "—";

                    string itemName = isItem
                    ? sched.EquipmentItem?.EquipmentItemName ?? "—"
                    : "—";

                    string status = isItem
                    ? sched.EquipmentItem?.EquipmentItemStatus ?? "Unknown"
                    : "—";

                    string startDate = sched.MaintenanceDate.HasValue
                    ? sched.MaintenanceDate.Value.ToString("MMM dd, yyyy", CultureInfo.InvariantCulture)
                    : "N/A";

                    string nextDateDisplay = "—";
                    if (!isItem)
                    {
                        if (sched.NextMaintenanceDate.HasValue)
                            nextDateDisplay = sched.NextMaintenanceDate.Value.ToString("MMM dd, yyyy", CultureInfo.InvariantCulture);
                        else if (!string.IsNullOrWhiteSpace(sched.Frequency) && sched.MaintenanceDate.HasValue)
                        {
                            var baseDate = sched.MaintenanceDate.Value.ToDateTime(TimeOnly.MinValue);
                            var computed = sched.Frequency.ToLower() switch
                            {
                                "weekly" => DateOnly.FromDateTime(baseDate.AddDays(7)),
                                "biweekly" => DateOnly.FromDateTime(baseDate.AddDays(14)),
                                "monthly" => DateOnly.FromDateTime(baseDate.AddMonths(1)),
                                "quarterly" => DateOnly.FromDateTime(baseDate.AddMonths(3)),
                                "yearly" => DateOnly.FromDateTime(baseDate.AddYears(1)),
                                _ => (DateOnly?)null
                            };
                            nextDateDisplay = computed.HasValue ? computed.Value.ToString("MMM dd, yyyy", CultureInfo.InvariantCulture) : "—";
                        }
                    }

                    <tr>
                        @if (allEquipmentLevel)
                        {
                            <td>@category</td>
                            <td>@equipmentName</td>
                            <td>@startDate</td>
                            <td>@nextDateDisplay</td>
                            <td>@(sched.Frequency ?? "—")</td>
                            <td>@(sched.Staff?.Name ?? "—")</td>
                            <td>@(sched.Remarks ?? "—")</td>
                            <td class="text-center">
                                <!-- DELETE: AJAX -->
                                <button type="button" class="btn btn-sm btn-danger"
                                        onclick="deleteSchedule(@sched.ScheduleId)">
                                    <i class="bi bi-trash"></i> Delete
                                </button>
                            </td>
                        }

                        else if (allItemLevel)
                        {
                            <td>@category</td>
                            <td>@itemName</td>
                            <td>
                                @if (!string.IsNullOrEmpty(status))
                                {
                                    var badgeClass = status switch
                                    {
                                        "Available" => "bg-success",
                                        "Under Maintenance" => "bg-warning text-dark",
                                        "Out of Order" => "bg-danger",
                                        _ => "bg-secondary"
                                    };
                                    <span class="badge @badgeClass">@status</span>
                                }
                                else
                                {
                                    <span class="text-muted">—</span>
                                }
                            </td>
                            <td>@startDate</td>
                            <td>@(sched.Staff?.Name ?? "—")</td>
                            <td>@(sched.Remarks ?? "—")</td>
                        }
                        else
                        {
                            <td>@category</td>
                            <td>@equipmentName</td>
                            <td>@(isItem ? itemName : "—")</td>
                            <td>
                                @if (isItem)
                                {
                                    var badgeClass = status switch
                                    {
                                        "Available" => "bg-success",
                                        "Under Maintenance" => "bg-warning text-dark",
                                        "Out of Order" => "bg-danger",
                                        _ => "bg-secondary"
                                    };
                                    <span class="badge @badgeClass">@status</span>
                                }
                                else
                                {
                                    <span class="text-muted">—</span>
                                }
                            </td>
                            <td>@startDate</td>
                            <td>@nextDateDisplay</td>
                            <td>@(sched.Frequency ?? "—")</td>
                            <td>@(sched.Staff?.Name ?? "—")</td>
                            <td>@(sched.Remarks ?? "—")</td>
                        }
                    </tr>
                }
            }
            else
            {
                var colspan = allEquipmentLevel ? 8 : (allItemLevel ? 6 : 9); // Add 1 for buttons in equipment-level
                <tr>
                    <td colspan="@colspan" class="text-center text-muted py-4">
                        <i class="bi bi-calendar-x me-2"></i>No maintenance schedules found.
                    </td>
                </tr>
            }
        </tbody>

    </table>
</div>