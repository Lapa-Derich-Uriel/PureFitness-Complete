@model PureFitness.ViewModels.EquipmentViewModel

@{
    ViewBag.Title = "Equipment Management";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@section Styles {
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" />
    <style>
        .nav-tabs .nav-link.active {
            font-weight: 600;
            border-bottom: 3px solid #1E90FF;
        }

        .tab-content {
            margin-top: 20px;
        }

        table th {
            background: #f8f9fa;
        }

        button, .btn {
            transition: background-color 0.2s ease, transform 0.1s ease;
        }

            button:hover, .btn:hover {
                transform: scale(1.02);
            }
    </style>
}

<div class="container-fluid px-4">
    @Html.AntiForgeryToken()

    <!-- Tabs -->
    <ul class="nav nav-tabs mt-4" id="managementTabs" role="tablist">
        <li class="nav-item">
            <button class="nav-link active" id="equipment-tab" data-bs-toggle="tab" data-bs-target="#equipment" type="button">
                Equipment
            </button>
        </li>
        <li class="nav-item">
            <button class="nav-link" id="schedule-tab" data-bs-toggle="tab" data-bs-target="#schedule" type="button">
                Maintenance Schedule
            </button>
        </li>
        <li class="nav-item">
            <button class="nav-link" id="logs-tab" data-bs-toggle="tab" data-bs-target="#logs" type="button">
                Maintenance Logs
            </button>
        </li>
    </ul>

    <div class="tab-content">
        <!-- Equipment Tab -->
        <div class="tab-pane fade show active" id="equipment" role="tabpanel">
            <div class="d-flex justify-content-between align-items-center mt-3">
                <h4 class="fw-bold">Equipment Management</h4>
                <div class="col-md-3">
                    <select id="equipmentCategoryFilter" class="form-select">
                        <option value="">All Categories</option>
                        @if (Model?.Equipments != null)
                        {
                            foreach (var category in Model.Equipments.Select(e => e.EquipmentCategory).Distinct())
                            {
                                <option value="@category">@category</option>
                            }
                        }
                    </select>
                </div>
                <div class="col-md-4">
                    <input type="text" id="equipmentSearch" class="form-control" placeholder="Search equipment..." />
                </div>
                <button type="button" class="btn btn-dark" id="btn-add-equipment">
                    <i class="bi bi-plus-circle"></i> Add Equipment
                </button>
            </div>
            <div id="equipmentTableWrap" class="mt-3">
                @if (Model?.Equipments != null && Model.Equipments.Any())
                {
                    @await Html.PartialAsync("_EquipmentTable", Model.Equipments)
                }
                else
                {
                    <div class="alert alert-light text-center py-3">No equipment data available.</div>
                }
            </div>
        </div>

        <!-- Schedule Tab -->
        <div class="tab-pane fade" id="schedule" role="tabpanel">
            <h4 class="fw-bold mt-3">Maintenance Schedules</h4>

            <!-- Sub Tabs -->
            <ul class="nav nav-pills mt-3" id="scheduleSubTabs" role="tablist">
                <li class="nav-item">
                    <button class="nav-link active" id="general-schedule-tab" data-bs-toggle="tab" data-bs-target="#general-schedule" type="button">
                        General Equipment
                    </button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" id="item-schedule-tab" data-bs-toggle="tab" data-bs-target="#item-schedule" type="button">
                        Specific Item
                    </button>
                </li>
            </ul>

            <div class="tab-content mt-3">
                <!-- General Equipment Schedule -->
                <div class="tab-pane fade show active" id="general-schedule" role="tabpanel">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="fw-semibold">General Equipment Schedules</h5>
                        <button class="btn btn-dark" id="btn-add-general-schedule">
                            <i class="bi bi-plus-circle"></i> Add Schedule
                        </button>
                    </div>

                    <div id="generalScheduleWrap" class="mt-3">
                        @{
                            // ✅ General schedules = ones that are linked directly to Equipment (not EquipmentItem)
                            var generalSchedules = Model?.EquipmentSchedules?
                            .Where(s => s.EquipmentItemId == null)
                            .ToList() ?? new List<PureFitness.Models.EquipmentSchedule>();
                        }

                        @if (generalSchedules.Any())
                        {
                            @await Html.PartialAsync("_MaintenanceSchedule", generalSchedules)
                        }
                        else
                        {
                            <div class="alert alert-light text-center py-3">
                                No general schedules available.
                            </div>
                        }
                    </div>
                </div>

                <!-- Item Schedule -->
                <div class="tab-pane fade" id="item-schedule" role="tabpanel">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="fw-semibold">Specific Item Schedules</h5>
                        <button class="btn btn-dark" id="btn-add-item-schedule">
                            <i class="bi bi-plus-circle"></i> Add Schedule
                        </button>
                    </div>

                    <div id="itemScheduleWrap" class="mt-3">
                        @{
                            // ✅ Item schedules = ones linked to a specific EquipmentItem
                            var itemSchedules = Model?.EquipmentSchedules?
                            .Where(s => s.EquipmentItemId != null)
                            .ToList() ?? new List<PureFitness.Models.EquipmentSchedule>();
                        }

                        @if (itemSchedules.Any())
                        {
                            @await Html.PartialAsync("_MaintenanceSchedule", itemSchedules)
                        }
                        else
                        {
                            <div class="alert alert-light text-center py-3">
                                No item schedules available.
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>

        <!-- Logs Tab -->
        <div class="tab-pane fade" id="logs" role="tabpanel">
            <h4 class="fw-bold mt-3">Maintenance Logs</h4>
            <div id="logsTableWrap" class="mt-3">
                @if (Model?.EquipmentLogs != null && Model.EquipmentLogs.Any())
                {
                    @await Html.PartialAsync("_EquipmentLogs", Model.EquipmentLogs)
                }
                else
                {
                    <div class="alert alert-light text-center py-3">No maintenance logs available.</div>
                }
            </div>
        </div>
    </div>
</div>

<!-- Modal Containers -->
<div class="modal fade" id="modalGeneric" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content"></div>
    </div>
</div>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // ===== Helper Functions =====
        function antiForgeryToken() {
            return $('input[name="__RequestVerificationToken"]').first().val() || '';
        }

        function closeModal(modalId) {
            const modalEl = document.getElementById(modalId);
            const modal = bootstrap.Modal.getInstance(modalEl);
            if (modal) modal.hide();
        }

        function showLoading(target) {
            $(target).html('<div class="text-center py-4"><div class="spinner-border text-primary"></div></div>');
        }

        // ===== Refresh Helpers =====
        function refreshEquipmentTable() {
            showLoading('#equipmentTableWrap');
            $.get('/Equipment/EquipmentTable', html => $('#equipmentTableWrap').html(html));
        }

        function refreshLogs() {
            showLoading('#logsTableWrap');
            $.get('/Equipment/LogsTable', html => $('#logsTableWrap').html(html));
        }

        // 🔁 Refresh the schedules dynamically
        function refreshSchedules() {
            $.get('/Equipment/Schedules', function (html) {
                const $html = $(html);
                const generalWrap = $html.find('#generalScheduleWrap');
                const itemWrap = $html.find('#itemScheduleWrap');

                if (generalWrap.length) $('#generalScheduleWrap').replaceWith(generalWrap);
                if (itemWrap.length) $('#itemScheduleWrap').replaceWith(itemWrap);
            }).fail(function () {
                $('#generalScheduleWrap, #itemScheduleWrap').html(`
                    <div class="alert alert-danger text-center">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        Failed to load schedules. Please try again.
                    </div>
                `);
            });
        }

        // ===== Filters/Search =====
        function attachFilterSearch() {
            $('#equipmentCategoryFilter, #equipmentSearch').on('input change', function () {
                const category = $('#equipmentCategoryFilter').val().toLowerCase();
                const keyword = $('#equipmentSearch').val().toLowerCase();

                $('#equipmentTableWrap table tbody tr').each(function () {
                    const row = $(this);
                    const text = row.text().toLowerCase();
                    const rowCategory = row.find('td[data-category]').data('category')?.toLowerCase() || '';
                    const match = (!category || rowCategory === category) && (!keyword || text.includes(keyword));
                    row.toggle(match);
                });
            });
        }

        // ===== Remember & Restore Tabs =====
        function rememberTabState() {
            // Store current tab IDs in localStorage
            const mainTab = $('.nav-tabs .nav-link.active').attr('id');
            const subTab = $('#scheduleSubTabs .nav-link.active').attr('id');
            localStorage.setItem('activeMainTab', mainTab || '');
            localStorage.setItem('activeSubTab', subTab || '');
        }

        function restoreTabState() {
            const mainTab = localStorage.getItem('activeMainTab');
            const subTab = localStorage.getItem('activeSubTab');

            if (mainTab) {
                $(`#${mainTab}`).tab('show');
            }
            if (subTab) {
                $(`#${subTab}`).tab('show');
            }
        }

        // ====== MAIN SCRIPT ======
        $(function () {
            restoreTabState();
            attachFilterSearch();

            // Track tab clicks
            $('.nav-tabs .nav-link, #scheduleSubTabs .nav-link').on('shown.bs.tab', rememberTabState);

            // ---------------------------
            // ADD EQUIPMENT
            // ---------------------------
            $(document).on('click', '#btn-add-equipment', function () {
                $.get('/Equipment/AddEquipment', function (html) {
                    $('#modalGeneric .modal-content').html(html);
                    new bootstrap.Modal('#modalGeneric').show();
                });
            });

            // ---------------------------
            // EDIT EQUIPMENT
            // ---------------------------
            $(document).on('click', '.edit-equipment', function () {
                const id = $(this).data('id');
                $.get('/Equipment/EditEquipment/' + id, function (html) {
                    $('#modalGeneric .modal-content').html(html);
                    new bootstrap.Modal('#modalGeneric').show();
                });
            });

            // ---------------------------
            // DELETE EQUIPMENT
            // ---------------------------
            $(document).on('click', '.delete-equipment', function () {
                const id = $(this).data('id');
                if (!confirm('Are you sure you want to delete this equipment?')) return;

                $.ajax({
                    url: '/Equipment/Delete/' + id,
                    method: 'POST',
                    headers: { 'RequestVerificationToken': antiForgeryToken() },
                    success: function () {
                        // ✅ Full reload with tab memory
                        rememberTabState();
                        window.location.reload();
                    },
                    error: xhr => alert(xhr.responseText || 'Delete failed')
                });
            });

            // ---------------------------
            // VIEW ITEMS
            // ---------------------------
            $(document).on('click', '.view-items-btn', function () {
                const id = $(this).data('id');
                $.get('/Equipment/EquipmentItemList?equipmentId=' + id, function (html) {
                    $('#modalGeneric .modal-content').html(html);
                    new bootstrap.Modal('#modalGeneric').show();
                });
            });

            // ---------------------------
            // ADD GENERAL SCHEDULE
            // ---------------------------
            $(document).on('click', '#btn-add-general-schedule', function () {
                $.get('/Equipment/AddSchedule?type=equipment', function (html) {
                    $('#modalGeneric .modal-content').html(html);
                    new bootstrap.Modal('#modalGeneric').show();
                });
            });

            // ---------------------------
            // ADD SPECIFIC ITEM SCHEDULE
            // ---------------------------
            $(document).on('click', '#btn-add-item-schedule', function () {
                $.get('/Equipment/AddSchedule?type=item', function (html) {
                    $('#modalGeneric .modal-content').html(html);
                    new bootstrap.Modal('#modalGeneric').show();
                });
            });

            // ---------------------------
            // SUBMIT SCHEDULE FORM
            // ---------------------------
            $(document).on('submit', '#ScheduleForm', function (e) {
                e.preventDefault();
                const $f = $(this);

                $.ajax({
                    url: $f.attr('action'),
                    method: 'POST',
                    headers: { 'RequestVerificationToken': antiForgeryToken() },
                    data: $f.serialize(),
                    success: function () {
                        closeModal('modalGeneric');
                        // ✅ Save tab state before reload
                        rememberTabState();
                        window.location.reload();
                    },
                    error: xhr => alert(xhr.responseText || 'Save failed')
                });
            });

            // ---------------------------
            // SUBMIT EQUIPMENT FORM (Add/Edit)
            // ---------------------------
            $(document).on('submit', '#EquipmentForm', function (e) {
                e.preventDefault();
                const $form = $(this);
                $.ajax({
                    url: $form.attr('action'),
                    method: 'POST',
                    data: $form.serialize(),
                    headers: { 'RequestVerificationToken': antiForgeryToken() },
                    success: function () {
                        closeModal('modalGeneric');
                        rememberTabState();
                        window.location.reload();
                    },
                    error: xhr => alert(xhr.responseText || 'Save failed.')
                });
            });

            // ---------------------------
            // UPDATE EQUIPMENT ITEMS
            // ---------------------------
            $(document).on('submit', '#itemsForm', function (e) {
                e.preventDefault();
                const updates = [];
                $('.item-status').each(function () {
                    const id = $(this).data('id');
                    const status = $(this).val();
                    updates.push({ equipmentItemId: id, status: status });
                });

                $.ajax({
                    url: '/Equipment/UpdateItems',
                    method: 'POST',
                    contentType: 'application/json',
                    headers: { 'RequestVerificationToken': antiForgeryToken() },
                    data: JSON.stringify(updates),
                    success: function () {
                        alert('Item statuses updated successfully.');
                        closeModal('modalGeneric');
                        rememberTabState();
                        window.location.reload();
                    },
                    error: xhr => alert(xhr.responseText || 'Failed to update items.')
                });
            });
        });

        // ---------------------------
        // DELETE SCHEDULE
        // ---------------------------
        function deleteSchedule(scheduleId) {
            if (!confirm('Are you sure you want to delete this schedule?')) return;

            $.post('/Equipment/DeleteSchedule', {
                id: scheduleId,
                __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
            }, function (data) {
                if (data.success) {
                    alert('Schedule deleted successfully');
                    rememberTabState();
                    window.location.reload();
                } else {
                    alert('Error deleting schedule.');
                }
            });
        }
    </script>
}


